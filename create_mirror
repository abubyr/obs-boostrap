#!/bin/bash
# If you need to remove some packages from repo, specify them in environment variable PKG_REMOVE_LIST
while getopts ":u:t:p:a:da:v:h" FLAG; do
	case $FLAG in
		u)
			REPO_URL=$OPTARG
			;;
		t)
			REPO_TYPE=$OPTARG
			;;
		p)
			LOCAL_MIRROR_PATH=$OPTARG
			;;
		a)
			ARCH=$OPTARG
			;;
		d)
			TEMP_DIR=$OPTARG
			;;
		v)
			FUEL_VER=$OPTARG
			;;
		\?)
			echo "Invalid option: -$OPTARG. Use -h for help" >&2
			exit 1
			;;
		:)
			echo "Option -$OPTARG requires an argument." >&2
			exit 1
			;;
		h)
			echo -e "This script is able to create local mirrors of Debian/RPM repositories.\n\nUsage: $(basename $0) -u <source_repo_url> [-t <repo_type=RPM] [-v <fuel_version=5.1>] [-p <local_mirror_path>] [-a <arch>=x86_64] \
[-d <temp_download_dir>=/data/imports]\n\n \
-u <source_repo_url> 		- Mandatory. URL of repository project connected to. Needed for downloading repo index files.\n \
[-v <fuel_version>]     	- Optional. Version of FUEL. Default value: 5.1\n \
[-t <repo_type>]     		- Optional. Choose deb or rpm repo type. Default value: RPM.\n \
-p [<local_mirror_path>]	- Optional. Where to put repository mirror on OBS server.\n \
				  Default values:\n \
				  Ubuntu - /srv/obs/repos/local-fuel-<fuel_version>-ubuntu-deps.\n \
				  CentOS - /srv/obs/repos/local-fuel-<fuel_version>-centos-deps.\n \
[-a <arch>]          		- Optional. Repository architecture. Default value: x86_64.\n \
You can specify list of packages to remove from mirror, providing it in env variable REMOVE_LIST.\n \
For removing unnecessary packages glob *<name>* is used. If you don't want to delete some packages, whose names match to this glob, \
please, specify them in DONT_REMOVE environment variable."
			exit
			;;
	esac
done
shift $((OPTIND-1))
if [[ -z "$REPO_URL" ]]; then
	echo "Invalid usage. You should specify URL for downloading from. Use -h for help" >&2
	exit 1
fi
[[ -z "$REPO_TYPE" ]] && REPO_TYPE="RPM"
[[ -z "$FUEL_VERSION" ]] && FUEL_VERSION=5.1
if [[ -z "$TEMP_DIR" ]]; then
	TEMP_DIR="/data/imports"
	echo -e "You didn't specify full path to destination directory. $TEMP_DIR will be used as default repo location\n"
fi
if [[ -z "$ARCH" ]]; then
	ARCH="x86_64"
	echo -e "You didn't specify repo arch. $ARCH arch is assumed\n"
fi
if [[ ! -d "$TEMP_DIR" ]]; then
	if ! mkdir -p "$TEMP_DIR"; then echo "Temporary directory wasn't created. Exitting..."; exit 2; fi
else
	rm -rf $TEMP_DIR/*
fi
case "$REPO_TYPE" in
	"RPM"|"rpm")
		[[ -z "$LOCAL_MIRROR_PATH" ]] && LOCAL_MIRROR_PATH="/srv/obs/repos/local-fuel-$FUEL_VERSION-centos-deps"
		repo_init () {
			find "$TEMP_DIR" -name "*.rpm" -print0 | xargs -0 mv -t $LOCAL_MIRROR_PATH/$ARCH
			pushd $LOCAL_MIRROR_PATH
			createrepo .
			popd
		}
		REPO_DIR=$ARCH
		DELIM='-'
		;;
	"DEB"|"deb")
		[[ -z "$LOCAL_MIRROR_PATH" ]] && LOCAL_MIRROR_PATH="/srv/obs/repos/local-fuel-$FUEL_VERSION-ubuntu-deps"
		repo_init () {
			local dist=precise
			export REPREPRO_BASE_DIR=$LOCAL_MIRROR_PATH/reprepro
			if [ -d $REPREPRO_BASE_DIR ]; then
		  		mkdir -p $REPREPRO_BASE_DIR/conf
		        	cat > $REPREPRO_BASE_DIR/conf/distributions <<EOF
Origin: Mirantis
Label: Mirantis FUEL
Suite: unstable
Codename: $dist
Version: $FUEL_VERSION
Architectures: amd64 source i386
Components: main
Description: FUEL packages for Ubuntu 12.04 Precise Pangolin
UDebComponents: main
Contents: . .gz .bz2
EOF
	   		fi
			for i in $(find $TEMP_DIR -name \*deb) ; do reprepro includedeb $dist $i; done
	    		for i in $(find $TEMP_DIR -name \*udeb) ; do reprepro includeudeb $dist $i; done
		}
		REPO_DIR='reprepro'
		DELIM='_'
		;;
	*)
		echo "Invalid package_type. Should be either RPM or DEB"
		exit 1
		;;
esac

if [[ ! -d "$LOCAL_MIRROR_PATH" ]]; then
	if ! mkdir -p "$LOCAL_MIRROR_PATH"/"$REPO_DIR"; then echo "Local mirror directory wasn't created. Exitting..."; exit 2; fi
else
	rm -rf $LOCAL_MIRROR_PATH/*
	mkdir -p "$LOCAL_MIRROR_PATH"/"$REPO_DIR"
fi

#WGET_CUT_DIRS="$(echo $REPO_URL |sed  "s,[a-zA-Z0-9]*://,,;s,\/, ,g" | wc -w)"
wget --directory-prefix="$TEMP_DIR" --reject index.html* --mirror --no-parent -nd $REPO_URL
# Don't remove packages from DONT_REMOVE list. Move them to repo dir for avoiding deletion by shell glob (see below)
if [[ -n "$REMOVE_LIST" ]]; then
	if [[ -n "$DONT_REMOVE" ]]; then
		mkdir -p $TEMP_DIR/dont_rem_dir
		for pkg in $DONT_REMOVE
		do
			mv $TEMP_DIR/$pkg$DELIM[0-9]* $TEMP_DIR/dont_rem_dir/
		done
	fi
	# Remove openstack and fuel packages which will be built on OBS server
	for i in $REMOVE_LIST
	do
		rm -rf "$TEMP_DIR"/*$i*
	done
	if [[ -d $TEMP_DIR/dont_rem_dir ]]; then
		ls -A $TEMP_DIR/dont_rem_dir >/dev/null 2>&1 && mv $TEMP_DIR/dont_rem_dir/* $TEMP_DIR
		rm -rf $TEMP_DIR/dont_rem_dir
	fi
fi
repo_init
if grep obsrun /etc/passwd; then
	chown -R obsrun:obsrun $LOCAL_MIRROR_PATH
fi
rm -rf $TEMP_DIR
